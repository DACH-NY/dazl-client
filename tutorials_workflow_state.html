<!DOCTYPE html>
<html lang="" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Workflow State Example</title>
  

  <link rel="apple-touch-icon" sizes="180x180" href="_static/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="_static/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="_static/favicon-16x16.png" sizes="16x16"/>
  <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="dazl 7.2.0 documentation" href="index.html"/> 
</head>
<body>

   

  <header>
    dazl

  </header>
  <nav>
              
              
                
              
              
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrating.html">Migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="dazl.html">dazl package</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

              

  </nav>
  <main>
    
  <div class="section" id="workflow-state-example">
<span id="tutorials-workflow-state"></span><h1>Workflow State Example<a class="headerlink" href="#workflow-state-example" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this example is to demonstrate a multi-contract-creation dependency use-case: a sitution where the application must wait for multiple contracts to be created before it can proceed to the next step. This is similar to the “Message Ingester” sample application, but with the key difference that the state transitions in the “Message Ingester” workflow each depend solely on a single contract creation.</p>
<p>The workflow involving three parties: <code class="docutils literal notranslate"><span class="pre">Alice</span></code>, <code class="docutils literal notranslate"><span class="pre">Bob</span></code>, and <code class="docutils literal notranslate"><span class="pre">Operator</span></code>. When writing a DAML
application, we recommend the following steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Describe your workflow as a series of contracts in DAML.</p></li>
<li><p>Write one or more DAML test scenarios that walk through each step of the workflow, starting from creation of the genesis contract, through a sequence of <code class="docutils literal notranslate"><span class="pre">exercise</span></code> commands, to the final state of the workflow. (Note: The DAML test scenarios are used for verifying the steps of the workflow in a sequential manner. However, when the workflow is deployed to a live platflorm, the events that prompt steps in the workflow to move forward cannot be assumed to occur sequentially.)</p></li>
<li><p>Write your application.</p></li>
<li><p>Test your application on the sandbox. The ledger server implements the same API, so performance testing can be done with the same application.</p></li>
</ol>
</div></blockquote>
<p>The workflow for this application is as follows:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">GenesisContract</span></code>, is created. It describes the operation(s) that the operator of this workflow can perform. In this example, we have assigned the party name <code class="docutils literal notranslate"><span class="pre">Operator</span></code> to the GenesisContract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Operator</span></code> invites the <code class="docutils literal notranslate"><span class="pre">Bob</span></code> to be the ticket seller, and also invites <code class="docutils literal notranslate"><span class="pre">Alice</span></code> to be the ticket buyer.</p></li>
<li><p>Only after BOTH <code class="docutils literal notranslate"><span class="pre">Alice</span></code> and <code class="docutils literal notranslate"><span class="pre">Bob</span></code> have accepted their respective invitations  can the workflow progress to the next state (<code class="docutils literal notranslate"><span class="pre">TicketTransactionsInProgress</span></code>)</p></li>
<li><p>A ticket transaction occurs.</p></li>
<li><p>The workflow is completed.</p></li>
</ol>
<div class="section" id="daml-model">
<h2>DAML Model<a class="headerlink" href="#daml-model" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">WorkflowStateExample.daml</span></code></p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">daml</span> <span class="mf">1.0</span>
<span class="kr">module</span> <span class="nn">WorkflowStateExample</span> <span class="kr">where</span>

<span class="c1">-- The &quot;Workflow State Contract&quot; Best Practice.</span>
<span class="c1">-- </span>
<span class="c1">-- Purpose: To encapsulate the state of a workflow within a contract. This results in easier </span>
<span class="c1">-- development &amp; debugging because workflow milestones are clearly defined </span>

<span class="kr">template</span> <span class="kt">GenesisContract</span>
  <span class="kr">with</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

    <span class="kr">controller</span> <span class="n">operator</span> <span class="kr">can</span>
      <span class="n">anytime</span> <span class="kt">SetInitialWorkflowState</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">WorkflowSetupInProgress</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">WorkflowSetupInProgress</span> <span class="kr">with</span> <span class="n">operator</span><span class="ow">=</span><span class="n">operator</span>
      <span class="n">anytime</span> <span class="kt">InviteTicketBuyer</span> <span class="kr">with</span> <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketBuyerInvitation</span>
        <span class="n">to</span> <span class="kr">do</span>
          <span class="n">create</span> <span class="kt">TicketBuyerInvitation</span> <span class="kr">with</span> <span class="n">operator</span><span class="p">;</span> <span class="n">ticketBuyer</span><span class="p">;</span>
      <span class="n">anytime</span> <span class="kt">InviteTicketSeller</span> <span class="kr">with</span> <span class="n">ticketSeller</span><span class="kt">:</span> <span class="kt">Party</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketSellerInvitation</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">TicketSellerInvitation</span> <span class="kr">with</span> <span class="n">operator</span><span class="p">;</span> <span class="n">ticketSeller</span><span class="p">;</span>

<span class="kr">template</span> <span class="kt">TicketBuyerInvitation</span>
  <span class="kr">with</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

    <span class="kr">controller</span> <span class="n">ticketBuyer</span> <span class="kr">can</span>
      <span class="kt">AcceptTicketBuyerInvitation</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketBuyerRole</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">TicketBuyerRole</span> <span class="kr">with</span> <span class="n">ticketBuyer</span><span class="p">;</span> <span class="n">operator</span><span class="p">;</span>
 
<span class="kr">template</span> <span class="kt">TicketBuyerRole</span>
  <span class="kr">with</span>
    <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">ticketBuyer</span>

<span class="kr">template</span> <span class="kt">TicketSellerInvitation</span>
  <span class="kr">with</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">ticketSeller</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

    <span class="kr">controller</span> <span class="n">ticketSeller</span> <span class="kr">can</span>
      <span class="kt">AcceptTicketSellerInvitation</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketSellerRole</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">TicketSellerRole</span> <span class="kr">with</span> <span class="n">ticketSeller</span><span class="p">;</span> <span class="n">operator</span><span class="p">;</span>

<span class="kr">template</span> <span class="kt">TicketSellerRole</span>
  <span class="kr">with</span> 
    <span class="n">ticketSeller</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">ticketSeller</span>

    <span class="kr">controller</span> <span class="n">ticketSeller</span> <span class="kr">can</span>
      <span class="n">anytime</span> <span class="kt">OfferTicketPurchaseAgreement</span> <span class="kr">with</span> <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketPurchaseAgreementOffer</span> 
        <span class="n">to</span> <span class="n">create</span> <span class="kt">TicketPurchaseAgreementOffer</span> <span class="kr">with</span> <span class="n">ticketSeller</span><span class="p">;</span> <span class="n">ticketBuyer</span><span class="p">;</span> <span class="n">operator</span><span class="p">;</span>

<span class="kr">template</span> <span class="kt">TicketPurchaseAgreementOffer</span>
  <span class="kr">with</span>
    <span class="n">ticketSeller</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">ticketSeller</span>

    <span class="kr">controller</span> <span class="n">ticketBuyer</span> <span class="kr">can</span>
      <span class="kt">PurchaseTicket</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">TicketPurchaseAgreement</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">TicketPurchaseAgreement</span> <span class="kr">with</span> <span class="n">ticketSeller</span><span class="p">;</span> <span class="n">ticketBuyer</span><span class="p">;</span> <span class="n">operator</span><span class="p">;</span>

<span class="kr">template</span> <span class="kt">TicketPurchaseAgreement</span>
  <span class="kr">with</span>
    <span class="n">ticketSeller</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">ticketBuyer</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>

  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">ticketSeller</span>
    <span class="kr">signatory</span> <span class="n">ticketBuyer</span>
    <span class="kr">agreement</span> <span class="n">toText</span> <span class="n">ticketBuyer</span> <span class="o">&lt;&gt;</span> <span class="s">&quot; agrees to purchase ticket from &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">toText</span> <span class="n">ticketSeller</span> 

<span class="c1">-- Workflow state 1 of 3</span>
<span class="kr">template</span> <span class="kt">WorkflowSetupInProgress</span>
  <span class="kr">with</span>
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

    <span class="kr">controller</span> <span class="n">operator</span> <span class="kr">can</span>
      <span class="kt">TicketTransactionsInProgress</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">WorkflowTicketTransactionsInProgress</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">WorkflowTicketTransactionsInProgress</span> <span class="kr">with</span> <span class="n">operator</span>

<span class="c1">-- Workflow state 2 of 3</span>
<span class="kr">template</span> <span class="kt">WorkflowTicketTransactionsInProgress</span>
  <span class="kr">with</span> 
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

    <span class="kr">controller</span> <span class="n">operator</span> <span class="kr">can</span>
      <span class="kt">WorkflowCompleted</span>
        <span class="n">returning</span> <span class="kt">ContractId</span> <span class="kt">WorkflowCompleted</span>
        <span class="n">to</span> <span class="n">create</span> <span class="kt">WorkflowCompleted</span> <span class="kr">with</span> <span class="n">operator</span>

<span class="c1">-- Workflow state 3 of 3</span>
<span class="kr">template</span> <span class="kt">WorkflowCompleted</span>
  <span class="kr">with</span> 
    <span class="n">operator</span><span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">operator</span>

<span class="nf">test</span> <span class="n">ticketTransactionTest</span> <span class="ow">=</span> 
  <span class="n">scenario</span>
    <span class="c1">-- create the genesis contract</span>
    <span class="n">genesisContract</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">create</span> <span class="kt">GenesisContract</span> <span class="kr">with</span> <span class="n">operator</span><span class="ow">=</span><span class="kt">&#39;Operator&#39;</span>
    <span class="c1">-- set the initial workflow state (InviteParticipantsInProgress)</span>
    <span class="n">workflowSetupInProgress</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">genesisContract</span> <span class="kt">SetInitialWorkflowState</span>

    <span class="c1">-- initial state: InviteParticipantsInProgress</span>
    <span class="c1">-- operator shall invite all the participants to the workflow, and respective participant role contracts </span>
    <span class="c1">-- shall be created</span>

    <span class="c1">-- note: scenarios list actions in series, but these actions do not have a guaranteed order when running on the Platform </span>

    <span class="n">ticketSellerInvitation</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">genesisContract</span> <span class="kt">InviteTicketSeller</span> <span class="kr">with</span> <span class="n">ticketSeller</span><span class="ow">=</span><span class="kt">&#39;Bob&#39;</span>
    <span class="n">ticketSellerRole</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Bob&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">ticketSellerInvitation</span> <span class="kt">AcceptTicketSellerInvitation</span>

    <span class="n">ticketBuyerInvitation</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">genesisContract</span> <span class="kt">InviteTicketBuyer</span> <span class="kr">with</span> <span class="n">ticketBuyer</span><span class="ow">=</span><span class="kt">&#39;Alice&#39;</span>
    <span class="n">ticketBuyerRole</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Alice&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">ticketBuyerInvitation</span> <span class="kt">AcceptTicketBuyerInvitation</span>
    
    <span class="c1">-- next state: TicketTransactionsInProgress</span>
    <span class="c1">-- the application must detect when this state transition can occur, and then perform this exercise</span>
    <span class="n">workflowTicketTransactionsInProgress</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">workflowSetupInProgress</span> <span class="kt">TicketTransactionsInProgress</span>

    <span class="c1">-- In this phase of the workflow, one or more ticket purchases may occur</span>

    <span class="c1">-- a ticket is purchsed</span>
    <span class="n">offerTicketPurchaseAgreement</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Bob&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">ticketSellerRole</span> <span class="kt">OfferTicketPurchaseAgreement</span> <span class="kr">with</span> <span class="n">ticketBuyer</span><span class="ow">=</span><span class="kt">&#39;Alice&#39;</span>
    <span class="kt">&#39;Alice&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">offerTicketPurchaseAgreement</span> <span class="kt">PurchaseTicket</span>

    <span class="c1">-- ...more ticket purchases may occur here</span>
    
    <span class="c1">-- next state: WorkflowCompleted</span>
    <span class="c1">-- the application must detect when this state transition shall occur, and then perform this exercise</span>
    <span class="n">workflowCompleted</span> <span class="ow">&lt;-</span> <span class="kt">&#39;Operator&#39;</span> <span class="n">commits</span> <span class="n">exercise</span> <span class="n">workflowTicketTransactionsInProgress</span> <span class="kt">WorkflowCompleted</span>

    <span class="kr">return</span> <span class="p">{</span>
      <span class="n">genesisContract</span><span class="ow">=</span><span class="n">genesisContract</span><span class="p">;</span>
      <span class="n">ticketBuyerInvitation</span><span class="ow">=</span><span class="n">ticketBuyerInvitation</span><span class="p">;</span>
      <span class="n">ticketBuyerRole</span><span class="ow">=</span><span class="n">ticketBuyerRole</span><span class="p">;</span>
      <span class="n">ticketSellerInvitation</span><span class="ow">=</span><span class="n">ticketSellerInvitation</span><span class="p">;</span>
      <span class="n">ticketSellerRole</span><span class="ow">=</span><span class="n">ticketSellerRole</span><span class="p">;</span>
      <span class="n">workflowCompleted</span><span class="ow">=</span><span class="n">workflowCompleted</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ticketTransactionTest</span></code> scenario describes a sample execution of the workflow, and is the basis from from which
our Python application will be designed.</p>
</div>
<div class="section" id="python-application">
<h2>Python Application<a class="headerlink" href="#python-application" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">store.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) 2017-2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ContractStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="ow">or</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
        <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">((</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the contract under the given name.</span>

<span class="sd">        :param name: The &quot;name&quot; of the contract.</span>
<span class="sd">        :return: A ``Future`` that resolves to a (cid, cdata) tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Finding in store </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finding in store </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
        <span class="k">return</span> <span class="n">future</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Deleting from store </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark the contract as archived.</span>

<span class="sd">        :param cid: The contract ID that is no longer active.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="n">cid</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_resolve_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_match</span><span class="p">):</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cid</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_match</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">xs</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">workflow_state_example.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) 2017-2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>

<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">store</span> <span class="kn">import</span> <span class="n">ContractStore</span>

<span class="kn">from</span> <span class="nn">dazl</span> <span class="kn">import</span> <span class="n">create</span><span class="p">,</span> <span class="n">exercise</span>
<span class="kn">from</span> <span class="nn">dazl.client</span> <span class="kn">import</span> <span class="n">create_client</span>
<span class="kn">from</span> <span class="nn">dazl.plugins</span> <span class="kn">import</span> <span class="n">LedgerCapturePlugin</span>

<span class="n">operator</span> <span class="o">=</span> <span class="s2">&quot;Operator&quot;</span>
<span class="n">alice</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span>
<span class="n">bob</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span>

<span class="n">parties</span> <span class="o">=</span> <span class="p">[</span><span class="n">operator</span><span class="p">,</span> <span class="n">alice</span><span class="p">,</span> <span class="n">bob</span><span class="p">]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:7600/&quot;</span>
<span class="n">contract_store</span> <span class="o">=</span> <span class="n">ContractStore</span><span class="p">()</span>
<span class="n">transaction_limit</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">create_initial_workflow_state</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="n">workflow_state</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;SetInitialWorkflowState&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="k">return</span> <span class="n">workflow_state</span>


<span class="k">def</span> <span class="nf">invite_ticket_seller</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_seller_invitation</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;InviteTicketSeller&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ticketSeller&quot;</span><span class="p">:</span> <span class="n">bob</span><span class="p">})]</span>
    <span class="k">return</span> <span class="n">ticket_seller_invitation</span>


<span class="k">def</span> <span class="nf">invite_ticket_buyer</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_buyer_invitation</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;InviteTicketBuyer&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ticketBuyer&quot;</span><span class="p">:</span> <span class="n">alice</span><span class="p">})]</span>
    <span class="k">return</span> <span class="n">ticket_buyer_invitation</span>


<span class="c1"># DOC_BEGIN: FUNCTION_ACCEPT_INVITE</span>
<span class="k">def</span> <span class="nf">accept_ticket_seller_invite</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_seller_role</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;AcceptTicketSellerInvitation&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ticketSellerRole1&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ticket_seller_role</span>


<span class="k">def</span> <span class="nf">accept_ticket_buyer_invite</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_buyer_role</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;AcceptTicketBuyerInvitation&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ticketBuyerRole1&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ticket_buyer_role</span>


<span class="c1"># DOC_END: FUNCTION_ACCEPT_INVITE</span>

<span class="c1"># DOC_BEGIN: FUNCTION_MULTI_CREATION_DEPENDENCY</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">transition_to_ticket_transactions_in_progress</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ticketSellerRole1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ticketBuyerRole1&quot;</span><span class="p">)</span>
    <span class="n">workflow_ticket_transactions_in_progress</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;TicketTransactionsInProgress&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;workflowTicketTransactionsInProgress&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workflow_ticket_transactions_in_progress</span>


<span class="c1"># DOC_END: FUNCTION_MULTI_CREATION_DEPENDENCY</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">offer_ticket_purchase_agreement</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowTicketTransactionsInProgress&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;workflowTicketTransactionsInProgress&quot;</span><span class="p">)</span>
    <span class="n">offer_ticket_purchase_agreement</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;OfferTicketPurchaseAgreement&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ticketBuyer&quot;</span><span class="p">:</span> <span class="n">alice</span><span class="p">})</span>
    <span class="p">]</span>
    <span class="k">global</span> <span class="n">transaction_limit</span>
    <span class="k">if</span> <span class="n">transaction_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">transaction_limit</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">offer_ticket_purchase_agreement</span>


<span class="k">def</span> <span class="nf">purchase_ticket</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowTicketTransactionsInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_purchase_agreement</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;PurchaseTicket&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="k">return</span> <span class="n">ticket_purchase_agreement</span>


<span class="k">def</span> <span class="nf">save_purchase_agreement</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowTicketTransactionsInProgress&quot;&quot;&quot;</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;purchase_agreement&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">transition_to_workflow_completed</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;purchase_agreement&quot;</span><span class="p">)</span>
    <span class="c1"># move on to the next phase of the workflow after 1 purchase agreement has been created</span>
    <span class="n">workflow_completed</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;WorkflowCompleted&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="k">return</span> <span class="n">workflow_completed</span>


<span class="k">def</span> <span class="nf">register_event_handlers</span><span class="p">(</span><span class="n">client_mgr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register event handlers with the appropriate clients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initial workflow state (1 of 3): &quot;InviteParticipantsInProgress&quot;</span>

    <span class="c1"># Define a ledger client associated with the &#39;Operator&#39; party, and how it reacts to events</span>
    <span class="n">operator_client</span> <span class="o">=</span> <span class="n">client_mgr</span><span class="o">.</span><span class="n">new_client</span><span class="p">(</span><span class="s2">&quot;Operator&quot;</span><span class="p">)</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span>
        <span class="s2">&quot;WorkflowStateExample.GenesisContract&quot;</span><span class="p">,</span> <span class="n">create_initial_workflow_state</span>
    <span class="p">)</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.GenesisContract&quot;</span><span class="p">,</span> <span class="n">invite_ticket_seller</span><span class="p">)</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.GenesisContract&quot;</span><span class="p">,</span> <span class="n">invite_ticket_buyer</span><span class="p">)</span>

    <span class="c1"># define a ledger client associated with the ticket seller, and how it reacts to events</span>
    <span class="n">bob_client</span> <span class="o">=</span> <span class="n">client_mgr</span><span class="o">.</span><span class="n">new_client</span><span class="p">(</span><span class="n">bob</span><span class="p">)</span>
    <span class="n">bob_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span>
        <span class="s2">&quot;WorkflowStateExample.TicketSellerInvitation&quot;</span><span class="p">,</span> <span class="n">accept_ticket_seller_invite</span>
    <span class="p">)</span>

    <span class="c1"># define a ledger client associated with the ticket buyer, and how it reacts to events</span>
    <span class="n">alice_client</span> <span class="o">=</span> <span class="n">client_mgr</span><span class="o">.</span><span class="n">new_client</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
    <span class="n">alice_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span>
        <span class="s2">&quot;WorkflowStateExample.TicketBuyerInvitation&quot;</span><span class="p">,</span> <span class="n">accept_ticket_buyer_invite</span>
    <span class="p">)</span>

    <span class="c1"># transition to workflow state: &quot;TicketTransactionsInProgress&quot;</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span>
        <span class="s2">&quot;WorkflowStateExample.WorkflowSetupInProgress&quot;</span><span class="p">,</span>
        <span class="n">transition_to_ticket_transactions_in_progress</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># workflow state (2 of 3): &quot;TicketTransactionsInProgress&quot;</span>
    <span class="n">bob_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.TicketSellerRole&quot;</span><span class="p">,</span> <span class="n">offer_ticket_purchase_agreement</span><span class="p">)</span>

    <span class="c1"># alice purchases a ticket</span>
    <span class="n">alice_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.TicketPurchaseAgreementOffer&quot;</span><span class="p">,</span> <span class="n">purchase_ticket</span><span class="p">)</span>
    <span class="n">alice_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.TicketPurchaseAgreement&quot;</span><span class="p">,</span> <span class="n">save_purchase_agreement</span><span class="p">)</span>

    <span class="c1"># transition to workflow state (3 of 3): &quot;WorkflowCompleted&quot;</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">on_created</span><span class="p">(</span>
        <span class="s2">&quot;WorkflowStateExample.WorkflowTicketTransactionsInProgress&quot;</span><span class="p">,</span>
        <span class="n">transition_to_workflow_completed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># all event handlers are defined; create the genesis contract, and all other event handlers shall react thereafter</span>
    <span class="n">operator_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
        <span class="p">[</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;WorkflowStateExample.GenesisContract&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;Operator&quot;</span><span class="p">})]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>

    <span class="k">with</span> <span class="n">create_client</span><span class="p">(</span><span class="n">parties</span><span class="o">=</span><span class="n">parties</span><span class="p">,</span> <span class="n">participant_url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">client_mgr</span><span class="p">:</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">LedgerCapturePlugin</span><span class="o">.</span><span class="n">stdout</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_mgr</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">inspector</span><span class="p">)</span>
            <span class="n">register_event_handlers</span><span class="p">(</span><span class="n">client_mgr</span><span class="p">)</span>
            <span class="n">ledger_run</span> <span class="o">=</span> <span class="n">client_mgr</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ledger_run</span><span class="o">.</span><span class="n">exit_code</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">inspector</span><span class="o">.</span><span class="n">dump_all</span><span class="p">()</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;da&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;da&quot;</span><span class="p">,</span> <span class="s2">&quot;sandbox&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<dl class="simple">
<dt>To run this code sample:</dt><dd><ol class="arabic simple">
<li><p>Download the SDK</p></li>
<li><p>create a new project: <code class="docutils literal notranslate"><span class="pre">da</span> <span class="pre">new</span> <span class="pre">my-project-name-here</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">my-project-name-here</span></code></p></li>
<li><p>Create a file, WorkflowStateExample.daml, that contains the above listed DAML.</p></li>
<li><p>Create a file, workflow_state_sample.py, that contains the Python code for “workflow_state_example.py” listed above.</p></li>
<li><p>Create a file, store.py, that contains, that contains the Python code for “store.py” listed above.</p></li>
<li><p>Download the dazl-starter template (which also creates a Python venv): <code class="docutils literal notranslate"><span class="pre">da</span> <span class="pre">project</span> <span class="pre">add</span> <span class="pre">dazl-starter</span></code></p></li>
<li><p>Run the application: <code class="docutils literal notranslate"><span class="pre">./venv/bin/python3</span> <span class="pre">workflow_state_example.py</span></code></p></li>
</ol>
</dd>
</dl>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">accept_ticket_seller_invite()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">accept_ticket_buyer_invite()</span></code> store their respective contracts into <code class="docutils literal notranslate"><span class="pre">contract_store</span></code>. This is the first step in setting up a multi-contract-creation dependency.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">accept_ticket_seller_invite</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_seller_role</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;AcceptTicketSellerInvitation&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ticketSellerRole1&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ticket_seller_role</span>


<span class="k">def</span> <span class="nf">accept_ticket_buyer_invite</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow state: WorkflowSetupInProgress&quot;&quot;&quot;</span>
    <span class="n">ticket_buyer_role</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;AcceptTicketBuyerInvitation&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ticketBuyerRole1&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ticket_buyer_role</span>


</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">transition_to_ticket_transactions_in_progress()</span></code> performs lookups into <code class="docutils literal notranslate"><span class="pre">contract_store</span></code>. These lookups will wait until the specified contract keys are present in the <code class="docutils literal notranslate"><span class="pre">contract_store</span></code>, and only perform the <code class="docutils literal notranslate"><span class="pre">exercise</span></code> command after that point. Thus, BOTH the <cite>TicketSellerRole</cite> and the <cite>TicketBuyerRole</cite> must be created before the application can transition to the next step in the workflow.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">transition_to_ticket_transactions_in_progress</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ticketSellerRole1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">contract_store</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ticketBuyerRole1&quot;</span><span class="p">)</span>
    <span class="n">workflow_ticket_transactions_in_progress</span> <span class="o">=</span> <span class="p">[</span><span class="n">exercise</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;TicketTransactionsInProgress&quot;</span><span class="p">,</span> <span class="p">{})]</span>
    <span class="n">contract_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;workflowTicketTransactionsInProgress&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workflow_ticket_transactions_in_progress</span>


</pre></div>
</div>
</div>
<div class="section" id="application-output">
<h2>Application Output<a class="headerlink" href="#application-output" title="Permalink to this headline">¶</a></h2>
<p>This application will produce this output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Info</span><span class="p">]</span> <span class="n">Starting</span><span class="p">:</span>
    <span class="n">Sandbox</span> <span class="n">ledger</span> <span class="n">server</span>
    <span class="o">.../</span><span class="n">daml</span><span class="o">/</span><span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">daml</span>
    <span class="k">with</span> <span class="n">no</span> <span class="n">scenario</span> <span class="ow">and</span> <span class="n">binding</span> <span class="n">to</span> <span class="n">port</span> <span class="mi">7600</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">Sandbox</span><span class="o">...</span><span class="n">ok</span>
<span class="mi">5</span> <span class="n">total</span> <span class="n">contracts</span> <span class="n">over</span> <span class="mi">5</span> <span class="n">templates</span>
<span class="o">+--</span> <span class="n">party</span> <span class="s1">&#39;Alice&#39;</span> <span class="p">(</span><span class="n">block</span> <span class="n">heights</span> <span class="mi">2</span> <span class="n">to</span> <span class="mi">9</span><span class="p">)</span>
<span class="o">|+-</span> <span class="n">party</span> <span class="s1">&#39;Bob&#39;</span> <span class="p">(</span><span class="n">block</span> <span class="n">heights</span> <span class="mi">2</span> <span class="n">to</span> <span class="mi">9</span><span class="p">)</span>
<span class="o">||+</span> <span class="n">party</span> <span class="s1">&#39;Operator&#39;</span> <span class="p">(</span><span class="n">block</span> <span class="n">heights</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">9</span><span class="p">)</span>
<span class="o">|||</span>

<span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">GenesisContract</span> <span class="p">(</span><span class="mi">1</span> <span class="n">contract</span><span class="p">)</span> <span class="o">----------------------------------------------------------------------</span>
    <span class="c1">#cid operator</span>
  <span class="n">C</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="n">_</span> <span class="n">Operator</span>

<span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">TicketBuyerRole</span> <span class="p">(</span><span class="mi">1</span> <span class="n">contract</span><span class="p">)</span> <span class="o">----------------------------------------------------------------------</span>
    <span class="c1">#cid operator ticketBuyer</span>
<span class="n">C</span>   <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="n">_</span> <span class="n">Operator</span> <span class="n">Alice</span>

<span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">TicketPurchaseAgreement</span> <span class="p">(</span><span class="mi">1</span> <span class="n">contract</span><span class="p">)</span> <span class="o">--------------------------------------------------------------</span>
    <span class="c1">#cid operator ticketBuyer ticketSeller</span>
<span class="n">CC</span>  <span class="mi">6</span><span class="p">:</span><span class="mi">2</span><span class="n">_</span> <span class="n">Operator</span> <span class="n">Alice</span>       <span class="n">Bob</span>

<span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">TicketSellerRole</span> <span class="p">(</span><span class="mi">1</span> <span class="n">contract</span><span class="p">)</span> <span class="o">---------------------------------------------------------------------</span>
    <span class="c1">#cid operator ticketSeller</span>
 <span class="n">C</span>  <span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="n">_</span> <span class="n">Operator</span> <span class="n">Bob</span>

<span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">WorkflowCompleted</span> <span class="p">(</span><span class="mi">1</span> <span class="n">contract</span><span class="p">)</span> <span class="o">--------------------------------------------------------------------</span>
    <span class="c1">#cid operator</span>
  <span class="n">C</span> <span class="mi">7</span><span class="p">:</span><span class="mi">2</span><span class="n">_</span> <span class="n">Operator</span>
<span class="n">stopping</span><span class="o">...</span> <span class="n">Sandbox</span> <span class="n">ledger</span> <span class="n">server</span>
<span class="o">.../</span><span class="n">daml</span><span class="o">/</span><span class="n">WorkflowStateExample</span><span class="o">.</span><span class="n">daml</span>
<span class="k">with</span> <span class="n">no</span> <span class="n">scenario</span> <span class="ow">and</span> <span class="n">binding</span> <span class="n">to</span> <span class="n">port</span> <span class="mi">7600</span>

<span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Thus, a <code class="docutils literal notranslate"><span class="pre">TicketPurchaseAgreement</span></code> is created. Also note that the contracts representing intermediate steps in the workflow (<code class="docutils literal notranslate"><span class="pre">WorkflowSetupInProgress</span></code>, and <code class="docutils literal notranslate"><span class="pre">WorkflowTicketTransactionsInProgress</span></code>) were created and then subsequently archived. Only the contract representing the final state, <code class="docutils literal notranslate"><span class="pre">WorkflowCompleted</span></code> is active.</p>
</div>
</div>


  </main>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'',
            VERSION:'7.2.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <footer> 
  </footer>
</body>
</html>